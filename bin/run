#!/usr/bin/env python

import os
import sys
import argparse

bin_dir = os.path.dirname(os.path.realpath(__file__))
src_dir = os.path.realpath(os.path.join(bin_dir, "../src/"))
sys.path.append(src_dir)

import bibtexparser
from bibtexparser.bparser import BibTexParser
from bibtexparser.bwriter import BibTexWriter
from bibtexparser.customization import homogeneize_latex_encoding
from bibtexparser.bibdatabase import BibDatabase
import main

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("filepath",
                        help="Path to the bibtex file",
                        type=str)
    parser.add_argument("-o", "--output-path",
                        help="Path the output files will be written to. Default to the output folder.",
                        type=str)
    args = parser.parse_args()

    output_path = args.output_path or os.path.realpath(os.path.join(bin_src, '../output/'))

    try:
        with open(args.filepath) as bibtex_file:
            parser = BibTexParser()
            parser.customization = homogeneize_latex_encoding
            bib_database = bibtexparser.load(bibtex_file, parser=parser)

            to_retain, to_dump = main.main(bib_database.entries)

            to_retain_db = BibDataBase()
            to_retain_db.entries = to_retain

            with open(os.path.join(output_path, 'filtered.bib'), 'w') as bibfile:
                bibfile.write(writer.write(to_retain_db))

            to_dump_db = BibDataBase()
            to_dump_db.entries = to_dump
            with open(os.path.join(output_path, 'dumped.bib'), 'w') as bibfile:
                bibfile.write(writer.write(to_dump_db))

    except IOError as e:
        logger.error("I/O error({0}): {1}".format(e.errno, e.strerror))
        sys.exit(1)
